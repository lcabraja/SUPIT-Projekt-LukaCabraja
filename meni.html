<!DOCTYPE html>
<html>

<head>
    <title>Meni Plan</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- stylesheets -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="css/based.css" rel="stylesheet">
    <link href="css/jquery-ui.css" rel="stylesheet">
    <!-- latest jQuery -->
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.js"></script>
</head>

<body class="backgroundimage">
    <!-- navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://www.youtube.com/watch?v=dQw4w9WgXcQ"><img style="max-height: 23px;padding: 0px; position: centered" alt="Algebra Logo" src="./img/algebra/Algebra-logo.png"></a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="./index.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span> Poƒçetna Stranica</a></li>
                    <li><a href="#"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> O Nama</a></li>
                    <li><a href="#"><span class="glyphicon glyphicon-calendar" aria-hidden="true"></span> Novosti</a></li>
                    <li class="active"><a href="#"><span class="glyphicon glyphicon-education" aria-hidden="true"></span> Meni Plan<span class="sr-only">(current)</span></a></li>
                    <li><a href="./kontakt.html"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Kontakt</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#">Link</a></li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>
    <div class="container-fluid">
        <h1 class="text-center">Odaberi meni</h1>
        <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-lg-6">
                <div style="margin-top: 40px; display:flex;">
                    <input class="form-control inputcustom" id="autocomplete">
                    <div class="appendbutton">
                        <button class="btn buttoncustom" onclick="wipeinput()"><span class="glyphicon glyphicon-remove-circle"></span></button>
                    </div>
                </div>
            </div>
            <div class="col-xs-12 col-sm-6 col-lg-6 colspace">
                <table class="table table-striped" id="stol">
                    <thead>
                        <tr>
                            <th>Kolegij</th>
                            <th>ECTS</th>
                            <th>Sati</th>
                            <th>P</th>
                            <th>V</th>
                            <th>Tip</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background-color: #fff">
                            <th class="borderline">Ukupno:</th>
                            <th class="borderline red b" id="ukupno-ects"></th>
                            <th class="borderline red b" id="ukupno-sati"></th>
                            <th class="borderline"></th>
                            <th class="borderline"></th>
                            <th class="borderline"></th>
                            <th class="borderline"></th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
    <script>
    let planurl = 'http://www.fulek.com/VUA/SUPIT/GetNastavniPlan';
    let kolegijurl = 'http://www.fulek.com/VUA/supit/GetKolegij/';
    var jsondata = [];
    var kolegiji = [];
    var tabledata = [];

    function wipeinput() {
        $("#autocomplete").val("");
    }

    function sum_data(tabledata) {
        var ects = 0;
        var sati = 0;
        for (var i = 0; i < tabledata.length; i++) {
            console.log('i:', i);
            console.log('tabledata[i]:', tabledata[i]);
            console.log('tabledata:', tabledata);
            ects += parseInt($("#" + tabledata[i] + " td:nth-child(2)").html());
            sati += parseInt($("#" + tabledata[i] + " td:nth-child(3)").html());
        }
        if (ects == 0 && sati == 0) {
            $("#ukupno-ects").html("");
            $("#ukupno-sati").html("");
            return null
        }
        $("#ukupno-ects").html(ects);
        $("#ukupno-sati").html(sati);
    }

    function removeButton(buttonId) {
        let popbut = tabledata.splice(tabledata.indexOf(buttonId), 1);
        kolegiji.push(jsondata.find(x => x.value == buttonId).label)
        $("#autocomplete").autocomplete({ source: kolegiji });
        $(`#${buttonId}`).remove();
        sum_data(tabledata);
    }

    // fetch data from url
    fetch(planurl)
        .then(res => res.json())
        .then((out) => {
            jsondata = out;
            jsondata.forEach(x => kolegiji.push(x.label));
            $("#autocomplete").autocomplete({
                source: kolegiji
            });
            $("#autocomplete").on("autocompleteclose", function(event, ui) {
                let key = $("#autocomplete").val();
                let result = jsondata.find(x => x.label == key)?.value;
                if (typeof result !== 'undefined') {
                    fetch(kolegijurl + result)
                        .then(res => res.json())
                        .then((out) => {
                            tabledata.push(out.id);
                            let popid = kolegiji.splice(kolegiji.indexOf(jsondata.find(x => x.value == out.id).label), 1)
                            $("#autocomplete").autocomplete({ source: kolegiji });
                            $('#stol tr:last').before(`<tr id="${out.id}"><td style="padding-top: 9px; padding-bottom: 9px;">${out.kolegij}</td><td class="ects">${out.ects}</td><td class="sati">${out.sati}</td><td>${out.predavanja}</td><td>${out.vjezbe}</td><td>${out.tip}</td><td style="padding: 1px; padding-top: 2px;"><button class="btn btn-default button" onclick="removeButton(${out.id})"><span class="glyphicon glyphicon-trash"></span></button></td></tr>`);
                            sum_data(tabledata);
                        })
                        .catch(err => { throw err; });
                }
            });
            //console.log('GET got: ', out);
        })
        .catch(err => { throw err });
    // text autocomplete function
    </script>
</body>

</html>